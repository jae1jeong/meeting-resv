generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("PRISMA_DATABASE_URL")
  directUrl = env("DATABASE_URL")
}

model User {
  id                  String               @id @default(cuid())
  email               String?              @unique
  password            String?
  name                String?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  emailVerified       Boolean?
  image               String?
  isAdmin             Boolean              @default(false)
  accounts            Account[]
  bookings            Booking[]
  bookingParticipants BookingParticipant[]
  groupMemberships    GroupMember[]
  sessions            Session[]
  refreshTokens       RefreshToken[]
}

model Account {
  id                    String    @id @default(cuid())
  userId                String
  providerId            String
  accountId             String
  password              String?
  refreshToken          String?
  accessToken           String?
  accessTokenExpiresAt  DateTime?
  idToken               String?
  scope                 String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId])
  @@index([userId])
}

model Session {
  id              String   @id @default(cuid())
  token           String   @unique
  userId          String
  expiresAt       DateTime
  ipAddress       String?
  userAgent       String?
  currentGroupId  String?  // 현재 선택된 그룹 ID
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@index([currentGroupId])
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@unique([identifier, token])
}

model Group {
  id                 String        @id @default(cuid())
  slug               String?       @unique // URL-friendly 식별자
  name               String
  description        String?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  codeExpiresAt      DateTime?
  inviteCode         String?       @unique
  backgroundBlur     Int           @default(10)
  backgroundImage    String?
  backgroundOpacity  Float         @default(0.5)
  backgroundPosition String        @default("center")
  members            GroupMember[]
  rooms              MeetingRoom[]

  @@index([inviteCode])
  @@index([slug])
}

model GroupMember {
  id       String   @id @default(cuid())
  userId   String
  groupId  String
  role     Role     @default(MEMBER)
  joinedAt DateTime @default(now())
  group    Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, groupId])
  @@index([userId])
  @@index([groupId])
}

model MeetingRoom {
  id        String    @id @default(cuid())
  name      String
  capacity  Int
  location  String?
  amenities String[]  @default([])
  groupId   String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  bookings  Booking[]
  group     Group     @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@index([groupId])
}

model Booking {
  id               String               @id @default(cuid())
  title            String
  description      String?
  roomId           String
  creatorId        String
  date             DateTime             @db.Date
  startTime        String
  endTime          String
  isRecurring      Boolean              @default(false)
  recurringId      String?
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  color            String               @default("bg-blue-500")
  creator          User                 @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  room             MeetingRoom          @relation(fields: [roomId], references: [id], onDelete: Cascade)
  participants     BookingParticipant[]
  recurringPattern RecurringPattern?

  @@unique([roomId, date, startTime, endTime])
  @@index([roomId])
  @@index([creatorId])
  @@index([date])
  @@index([recurringId])
}

model BookingParticipant {
  id        String   @id @default(cuid())
  bookingId String
  userId    String
  addedAt   DateTime @default(now())
  booking   Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([bookingId, userId])
  @@index([bookingId])
  @@index([userId])
}

model RecurringPattern {
  id          String               @id @default(cuid())
  bookingId   String               @unique
  type        RecurringType
  interval    Int                  @default(1)
  daysOfWeek  Int[]                @default([])
  dayOfMonth  Int?
  endDate     DateTime?            @db.Date
  occurrences Int?
  exceptions  RecurringException[]
  booking     Booking              @relation(fields: [bookingId], references: [id], onDelete: Cascade)
}

model RecurringException {
  id           String           @id @default(cuid())
  patternId    String
  date         DateTime         @db.Date
  type         ExceptionType
  newStartTime String?
  newEndTime   String?
  reason       String?
  pattern      RecurringPattern @relation(fields: [patternId], references: [id], onDelete: Cascade)

  @@index([patternId])
  @@index([date])
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([token])
}

enum Role {
  ADMIN
  MEMBER
}

enum RecurringType {
  WEEKLY
  BIWEEKLY
  MONTHLY
}

enum ExceptionType {
  SKIP
  MODIFY
}
